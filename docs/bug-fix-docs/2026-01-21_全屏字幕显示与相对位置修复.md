# Bug Fix: 全屏模式字幕不显示 & 窗口调整时字幕位置错乱

## 基本信息

| 项目 | 内容 |
|------|------|
| **发现时间** | 2026-01-21 13:20 (UTC+8) |
| **解决时间** | 2026-01-21 13:45 (UTC+8) |
| **修复耗时** | 约 25 分钟 |
| **影响范围** | 视频播放器字幕显示功能 |
| **严重程度** | 中 |

---

## Bug 描述

### 现象

1. **全屏模式字幕消失**: 用户点击视频全屏按钮后，字幕完全不显示
2. **窗口调整后字幕被裁剪**: 用户退出全屏或手动调整窗口大小后，字幕位置超出可视区域，部分或全部被隐藏

### 复现步骤

**Bug 1 - 全屏字幕消失**:
1. 播放带字幕的视频
2. 点击视频原生控件的全屏按钮
3. 字幕完全不显示

**Bug 2 - 字幕位置错乱**:
1. 在较大窗口下拖动字幕到某个位置
2. 退出全屏或缩小窗口
3. 字幕位置超出新窗口边界，被部分裁剪

---

## 根本原因分析

### Bug 1: 全屏字幕消失

浏览器全屏 API 的工作机制导致：当 `<video>` 元素本身进入全屏时，只有该 video 元素可见，所有在 video 外部的 DOM 元素（包括字幕组件）都不会显示。

Console 日志确认: `Fullscreen change detected: true VIDEO`，说明是 video 元素全屏而非包含字幕的容器。

### Bug 2: 字幕位置错乱

原有实现使用**绝对像素值**保存字幕位置：
- 在 1920x1080 窗口下，用户将字幕拖到 y=800px
- 退出全屏后窗口变为 1280x720，但字幕仍在 y=800px
- 800px 超出了 720px 的窗口高度，导致字幕被裁剪

---

## 修复方案

### 修复 1: 自定义全屏按钮 - 让容器全屏而非视频

**文件**: `src/App.tsx`

```tsx
// 添加 player-wrapper 的 ref
const playerWrapperRef = useRef<HTMLDivElement>(null)
const [isPlayerFullscreen, setIsPlayerFullscreen] = useState(false);

// 全屏切换函数 - 让 wrapper 全屏而非 video
const togglePlayerFullscreen = useCallback(() => {
  if (!playerWrapperRef.current) return;
  if (!document.fullscreenElement) {
    playerWrapperRef.current.requestFullscreen();
  } else {
    document.exitFullscreen();
  }
}, []);

// 在 player-wrapper 内添加自定义全屏按钮
<div className="player-wrapper" ref={playerWrapperRef}>
  <video ... />
  <button className="custom-fullscreen-btn" onClick={togglePlayerFullscreen}>
    {isPlayerFullscreen ? '⊠' : '⛶'}
  </button>
  <SubtitleOverlay ... />
</div>
```

通过让包含字幕的 `.player-wrapper` 全屏，字幕组件仍在全屏元素内部，可以正常显示。

### 修复 2: 隐藏原生全屏按钮

**文件**: `src/App.css`

```css
/* 隐藏视频原生全屏按钮，避免用户误用 */
.main-video::-webkit-media-controls-fullscreen-button {
  display: none !important;
}

.main-video::-moz-fullscreen-button {
  display: none !important;
}
```

防止用户使用原生全屏按钮（会导致字幕消失）。

### 修复 3: 字幕位置改用相对百分比

**文件**: `src/components/SubtitleOverlay.tsx`

```tsx
// 旧的数据结构 - 绝对像素
interface SubtitleSettings {
  x: number;      // 像素
  y: number;      // 像素
  width: number;  // 像素
}

// 新的数据结构 - 相对百分比
interface SubtitleSettings {
  xPercent: number;      // 0-1，水平中心点位置
  yPercent: number;      // 0-1，垂直位置
  widthPercent: number;  // 0-1，宽度占比
  fontSize: number;
}

// 拖拽结束时转换为百分比保存
const handleDragStop = useCallback((_e, data) => {
  const centerX = data.x + subtitleWidth / 2;
  const xPercent = centerX / containerSize.width;
  const yPercent = data.y / containerSize.height;
  // 保存百分比...
}, []);

// 渲染时从百分比计算像素
const pixelWidth = containerSize.width * settings.widthPercent;
const pixelX = containerSize.width * settings.xPercent - pixelWidth / 2;
const pixelY = containerSize.height * settings.yPercent;
```

使用相对百分比后，无论窗口如何变化，字幕始终保持在相对相同的位置。

### 修复 4: 监听窗口大小变化

**文件**: `src/components/SubtitleOverlay.tsx`

```tsx
const [containerSize, setContainerSize] = useState({ width: window.innerWidth, height: window.innerHeight });

useEffect(() => {
  const updateContainerSize = () => {
    const parent = containerRef.current?.parentElement;
    if (parent) {
      setContainerSize({ width: parent.clientWidth, height: parent.clientHeight });
    }
  };

  updateContainerSize();
  window.addEventListener('resize', updateContainerSize);
  return () => window.removeEventListener('resize', updateContainerSize);
}, []);
```

当窗口大小变化时，自动重新计算像素位置，保持相对位置不变。

---

## 技术要点

1. **浏览器全屏 API 限制**: `requestFullscreen()` 只会显示目标元素及其子元素，兄弟元素不可见
2. **React-RND 的 position 控制**: 使用受控的 `position` 和 `size` 属性，而非 `default`，才能响应状态变化
3. **相对定位 vs 绝对定位**: 响应式布局应使用相对单位（百分比、vh/vw），避免固定像素值
4. **Portal 的局限性**: 虽然 `createPortal` 可以将元素渲染到任意 DOM 节点，但 video 元素是替换元素，无法在其内部渲染子节点

---

## 验证步骤

1. 播放带字幕的视频，确认字幕正常显示
2. 点击右上角自定义全屏按钮（非视频控件的全屏按钮）
3. 确认全屏模式下字幕正常显示在底部
4. 按 ESC 或点击按钮退出全屏
5. 确认字幕位置正确，未被裁剪
6. 手动拖动窗口边框调整大小
7. 确认字幕保持在相对相同的位置
8. 拖动字幕到新位置，重复步骤 6-7

---

## 相关文件

| 文件 | 修改类型 |
|------|----------|
| `src/App.tsx` | 修改 - 添加 playerWrapperRef、togglePlayerFullscreen、自定义全屏按钮 |
| `src/App.css` | 修改 - 添加自定义全屏按钮样式、隐藏原生全屏按钮 |
| `src/components/SubtitleOverlay.tsx` | 修改 - 重构为相对百分比定位系统 |
| `src/components/SubtitleOverlay.css` | 修改 - 添加全屏字幕样式 |

---

## 后续优化建议

1. **双击全屏**: 考虑添加双击视频进入全屏的功能
2. **字幕位置预设**: 提供"底部居中"、"底部左侧"等预设位置选项
3. **键盘快捷键**: 添加 F 键切换全屏的快捷键
4. **记忆不同窗口尺寸的位置**: 可以为不同的窗口尺寸范围保存不同的偏好位置
